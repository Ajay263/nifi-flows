name: Snowflake Flow Diff on Pull Requests

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  execute_flow_diff:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    name: Executing Flow Diff
    steps:

      # ──────────────────────────────────────────────────────────────────────────
      # 1. Check out the HEAD of the Pull Request (merge commit)
      # ──────────────────────────────────────────────────────────────────────────
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          path: submitted-changes

      # ──────────────────────────────────────────────────────────────────────────
      # 2. Detect which NiFi flow definition files (.json) changed in the PR
      #    and build the flowA / flowB path lists consumed by the diff action.
      # ──────────────────────────────────────────────────────────────────────────
      - name: Get changed files
        id: files
        run: |
          cd submitted-changes

          # Grab every changed JSON file (NiFi flow definitions).
          # Tip: make the grep pattern more specific to your repo layout,
          #      e.g.  grep 'flows/.*\.json$'
          files=$(git diff --name-only \
            $(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }}) HEAD \
            | grep '\.json$')

          if [ -z "$files" ]; then
            echo "No NiFi flow definition files changed - skipping diff."
            echo "flowA=" >> $GITHUB_OUTPUT
            echo "flowB=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Convert newline-separated list to comma-separated (no trailing comma)
          bare=$(echo "$files" | tr '\n' ',' | sed 's/,$//')

          # Prefix paths so each tool knows which checkout to read from
          flowA=$(echo "$bare" | sed 's|[^,]\+|original-code/&|g')
          flowB=$(echo "$bare" | sed 's|[^,]\+|submitted-changes/&|g')

          echo "flowA=$flowA" >> $GITHUB_OUTPUT
          echo "flowB=$flowB" >> $GITHUB_OUTPUT

      # ──────────────────────────────────────────────────────────────────────────
      # 3. Check out the base branch (the state BEFORE the PR changes)
      # ──────────────────────────────────────────────────────────────────────────
      - name: Checkout original code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          path: original-code

      - name: Reset original-code to pre-PR commit
        run: cd original-code && git checkout HEAD^

      # ──────────────────────────────────────────────────────────────────────────
      # 4. Run the Snowflake Flow Diff action
      #    - Compares flowA (base) vs flowB (PR head)
      #    - Posts a human-readable diff comment on the pull request
      #    - Checkstyle validates NiFi best-practice rules on the new flow
      # ──────────────────────────────────────────────────────────────────────────
      - name: Snowflake Flow Diff
        # Skip this step if no flow files changed (outputs would be empty)
        if: steps.files.outputs.flowA != ''
        uses: snowflake-labs/snowflake-flow-diff@v0
        id: flowdiff
        with:
          flowA: ${{ steps.files.outputs.flowA }}
          flowB: ${{ steps.files.outputs.flowB }}

          # ── Checkstyle (optional) ──────────────────────────────────────────
          # Uncomment the lines below to enable NiFi best-practice checks.
          #
          # checkstyle: true
          #
          # Path to your custom checkstyle rules (optional).
          # If omitted, the action uses its built-in default rules.
          # checkstyle-rules: submitted-changes/.github/checkstyle/checkstyle-rules.yaml
          #
          # Set to true to fail the workflow when violations are found.
          # checkstyle-fail: true
